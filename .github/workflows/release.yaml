name: Release Rulesfile

on:
  - push

jobs:
  Release-Rulesfile:
    environment:
      name: testing

    runs-on: ubuntu-latest

    env:
      FALCOCTL_PKG: https://github.com/falcosecurity/falcoctl/releases/download/v0.4.0/falcoctl_0.4.0_linux_amd64.tar.gz
      FALCOCTL_REPO: github.com/falcosecurity/falcoctl
      FALCOCTL_BIN: falcoctl
      REGISTRY: ghcr.io
      RULESET_FILE: custom_falco_rules.yaml
      OCI_ARTIFACT_NAME: custom-rules
      OCI_ARTIFACT_VERSION: ${{ github.ref_name }}

    # These permissions are needed to interact with GitHub's OIDC Token endpoint.
    permissions:
      id-token: write
      contents: read
      packages: write

    steps:

      - name: Checkout Rules Repo
        uses: actions/checkout@v3

      - name: Checkout Falcoctl Repo
        uses: actions/checkout@v3
        with:
          repository: github.com/falcosecurity/falcoctl
          ref: main

      - name: Download falcoctl
        run: wget ${FALCOCTL_PKG}

    # - name: Extract falcoctl
    #   run: tar xvf $(basename $FALCOCTL_PKG) ${FALCOCTL_BIN}

      - name: Get lowercase OCI repo prefix
        run: |
          echo "OCI_REPO_PREFIX=${REGISTRY}/${GITHUB_REPOSITORY,,}" >>${GITHUB_ENV}

    # - name: Login to Github Packages
    #   uses: docker/login-action@v2
    #   with:
    #     registry: ${{ env.REGISTRY }}
    #     username: ${{ github.repository_owner }}
    #     password: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload OCI artifacts to GitHub packages
        env:
          ANNOTATION_SOURCE: ${{ github.server_url }}/${{ github.repository }}.git
        run: |
             echo ./${FALCOCTL_BIN} registry push \
             --type rulesfile \
             --version ${OCI_ARTIFACT_VERSION} \
             --annotation-source ${ANNOTATION_SOURCE} \
             ${OCI_REPO_PREFIX}/${OCI_ARTIFACT_NAME}:${OCI_ARTIFACT_VERSION} \
             ${RULESET_FILE}

      - name: Setup upterm session
        uses: lhotari/action-upterm@v1
        env:
          REGISTRY_USER: ${{ github.repository_owner }}
          REGISTRY_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPO_URL: ${{ github.server_url }}/${{ github.repository }}.git
          OCI_ARTIFACT_VERSION: ${{ github.ref_name }}
          OCI_ARTIFACT_NAME: custom-rules
          ANNOTATION_SOURCE: ${{ github.server_url }}/${{ github.repository }}.git
          FALCOCTL_REGISTRY_AUTH_BASIC: ghcr.io,${{ github.repository_owner }},${{ secrets.GITHUB_TOKEN }}
        with:
          limit-access-to-actor: true

